import streamlit as st
import openpyxl
from openpyxl.drawing.image import Image as XLImage
import io
from datetime import datetime

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.set_page_config(page_title="Engineer Report Generator", layout="wide")
st.title("üõ† Smart Dev Solution - Service Report")

# ‡πÉ‡∏ä‡πâ Tabs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏£‡∏Å
tab1, tab2 = st.tabs(["üìÑ General Info & Job Detail", "üì∏ Photo Report"])

with tab1:
    st.subheader("Part 1: General Information")
    col1, col2 = st.columns(2)
    with col1:
        date_issue = st.date_input("Date of Issue")
        ref_qt_no = st.text_input("Ref. QT No.")
        ref_po_no = st.text_input("Ref. PO No.")
        project_name = st.text_input("Project Name")
    with col2:
        doc_no = st.text_input("Doc. No.")
        location = st.text_input("Site / Location")
        client_name = st.text_input("Contact Person (Client)")
        contact_co_ltd = st.text_input("Contact (Co., Ltd.)")
    
    st.markdown("---")
    st.subheader("Part 2: Service Details")
    service_type = st.selectbox("Service Type", ["New", "Repairing", "Services", "Training", "Check", "Others"])
    job_performed = st.text_area("Job Performed (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô)", height=150)
    note = st.text_area("Note (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏)")
    eng_name = st.text_input("Engineer Name (Prepared By)")

with tab2:
    st.subheader("Part 3: Photo Report")
    st.write("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏á‡∏≤‡∏ô")
    
    # ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏ä‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    col_img, col_txt = st.columns([1, 1])
    with col_img:
        uploaded_photo = st.file_uploader("Upload Photo", type=['jpg', 'jpeg', 'png'])
        if uploaded_photo:
            st.image(uploaded_photo, caption="Preview", width=300)
            
    with col_txt:
        photo_description = st.text_area("Photo Description (‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)", height=150, placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...")

# --- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ---
st.markdown("---")
if st.button("üöÄ Generate Excel Report"):
    try:
        # 1. ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï (‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠ template.xlsx ‡πÉ‡∏ô GitHub)
        wb = openpyxl.load_workbook("template.xlsx")
        sheet = wb.active 

        # 2. ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô Cell ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏∞‡∏ö‡∏∏
        sheet["J5"] = date_issue.strftime('%d/%m/%Y')
        sheet["H7"] = location
        sheet["C9"] = client_name
        sheet["B16"] = project_name
        sheet["D17"] = job_performed
        
        # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏° Description ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ 2 ‡∏Ç‡∏≠‡∏á Excel (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ä‡πà‡∏≠‡∏á A35)
        # sheet["A35"] = photo_description

        # 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        excel_data = io.BytesIO()
        wb.save(excel_data)
        excel_data.seek(0)

        st.success("üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
        st.download_button(
            label="üì• Download Excel Report",
            data=excel_data,
            file_name=f"Report_{project_name}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    except Exception as e:
        st.error(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
